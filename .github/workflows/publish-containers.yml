name: Publish container images (GHCR)

on:
  workflow_run:
    workflows: ["Mark stable commit"]
    types: [completed]

jobs:
  publish:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository (with tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Checkout workflow_run commit
        run: |
          set -euo pipefail
          git checkout -f "${{ github.event.workflow_run.head_sha }}"

      - name: Compute version and stable flag
        id: info
        run: |
          set -euo pipefail

          SHA="$(git rev-parse HEAD)"
          V_TAG="$(git tag --points-at "${SHA}" --list 'v*' | sort -V | tail -n1)"
          [[ -n "$V_TAG" ]] || { echo "No version tag found"; exit 1; }

          VERSION="${V_TAG#v}"

          STABLE_SHA="$(git rev-parse -q --verify refs/tags/stable^{commit} 2>/dev/null || true)"
          IS_STABLE=false
          [[ "$STABLE_SHA" == "$SHA" ]] && IS_STABLE=true

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "is_stable=${IS_STABLE}" >> "$GITHUB_OUTPUT"

      - uses: docker/setup-buildx-action@v3
        with:
          use: true

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish all images
        run: |
          set -euo pipefail
          OWNER="${{ github.repository_owner }}" \
          VERSION="${{ steps.info.outputs.version }}" \
          IS_STABLE="${{ steps.info.outputs.is_stable }}" \
          bash scripts/build/publish.sh
